name: Build
on:
  pull_request:
    types: [ opened, reopened, synchronize ]
  push:
    branches: [ master, list ]

jobs:
  windows-msvc:
    strategy:
      matrix:
        config:
          - Release
          - Debug
        arch:
          - x64
          - x86
    name: Windows ${{ matrix.config }} ${{ matrix.arch }} Build (MSVC)
    runs-on: windows-latest
    steps:
    - name: Dummy 
      run: echo "${{ github.workspace }}\Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.arch }}" > ${{ github.workspace }}\Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.arch }}.exe
    - name: Uploading installer
      uses: actions/upload-artifact@v2
      with:
        name: Widelands ${{ matrix.config }} ${{ matrix.arch }} Installer (MSVC)
        path: ${{ github.workspace }}\Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.arch }}.exe

  macos:
    strategy:
      matrix:
        config:
          - release
          - debug
        compiler:
          - clang
    name: MacOS ${{ matrix.config }} ${{ matrix.compiler }}
    runs-on: macos-11
    steps:
    - name: Dummy 
      run: echo "${{ github.workspace }}/Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.compiler }}" > ${{ github.workspace }}/Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.compiler }}.dmg && exit 1
    - name: Uploading DMG
      uses: actions/upload-artifact@v2
      with:
        name: Widelands ${{ matrix.config }} ${{ matrix.compiler }} MacOS 11 AppImage
        path: ${{ github.workspace }}/Widelands-${{ github.sha }}-${{ matrix.config }}-${{ matrix.compiler }}.dmg
        
  gh_pre_release:
    if: ${{ github.ref == 'refs/heads/master' && always() }}
    needs: [windows-msvc, macos]
    runs-on: "ubuntu-latest"

    steps:
      - name: Check origin
        run: |
          if [ "${GITHUB_REPOSITORY%/*}" != "matthiakl" ]
          then
            echo "Skipping release creation on fork"
            exit 1
          fi
      - name: Download artifacts
        uses: actions/download-artifact@v2
        
      - name: Check missing artifacts
        run: |
          RELEASE_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/latest"
          curl -o latest_artifacts.list "$RELEASE_URL/artifacts.list"
          mkdir Widelands-latest
          for ARTIFACT in $(cat latest_artifacts.list)
          do
            MATRIX=$(echo $ARTIFACT | sed 's/Widelands-[0-9a-f]*-//' -)
            ls Widelands*/Widelands*${MATRIX} || \
              curl --output-dir Widelands-latest -O "$RELEASE_URL/$ARTIFACT"
          done
        
      - name: List artifacts
        run: |
          find . -name 'Widelands*' -type f -printf '%f\n' > artifacts.list
          
      - name: Updating latest pre-release
        uses: "marvinpinto/action-automatic-releases@v1.2.1"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Builds"
          files: |
            */*.exe
            */*.dmg
            artifacts.list

